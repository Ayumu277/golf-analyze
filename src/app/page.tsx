'use client';

import { useState } from 'react';

export default function Home() {
  const [selectedFile, setSelectedFile] = useState<File | null>(null);
  const [isAnalyzing, setIsAnalyzing] = useState(false);
  const [analysisResult, setAnalysisResult] = useState<string>('');

  const handleFileChange = (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0];
    if (file && file.type.startsWith('video/')) {
      setSelectedFile(file);
      setAnalysisResult(''); // æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚ŒãŸã‚‰çµæœã‚’ã‚¯ãƒªã‚¢
    } else {
      alert('å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
    }
  };

  // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’Base64ã«å¤‰æ›ã™ã‚‹é–¢æ•°
  const fileToBase64 = (file: File): Promise<string> => {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = () => {
        if (typeof reader.result === 'string') {
          // data:video/mp4;base64, ã®éƒ¨åˆ†ã‚’é™¤å»
          const base64 = reader.result.split(',')[1];
          resolve(base64);
        } else {
          reject(new Error('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ'));
        }
      };
      reader.onerror = error => reject(error);
    });
  };

  const handleAnalyze = async () => {
    if (!selectedFile) {
      alert('ã¾ãšå‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
      return;
    }

    setIsAnalyzing(true);
    setAnalysisResult('');

    try {
      // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ï¼ˆ500MBåˆ¶é™ï¼‰
      const maxSize = 500 * 1024 * 1024; // 500MB
      if (selectedFile.size > maxSize) {
        throw new Error('å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚µã‚¤ã‚ºãŒ500MBã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚ã‚ˆã‚Šå°ã•ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
      }

      // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’Base64ã«å¤‰æ›
      console.log('å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’Base64ã«å¤‰æ›ä¸­... (ã‚µã‚¤ã‚º:', Math.round(selectedFile.size / 1024 / 1024), 'MB)');
      const videoBase64 = await fileToBase64(selectedFile);

      // Gemini APIã«é€ä¿¡
      console.log('Gemini APIã«è§£æãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ä¸­...');
      const response = await fetch('/api/analyze', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          videoBase64,
        }),
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'è§£æAPIã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      }

      const result = await response.json();

      if (result.success) {
        setAnalysisResult(result.analysis + '\n\nğŸ“Š è§£æã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: ' + result.fileSize);
      } else {
        throw new Error(result.error || 'è§£æçµæœã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }

    } catch (error) {
      console.error('è§£æã‚¨ãƒ©ãƒ¼:', error);

      let errorMessage = 'è§£æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';

      if (error instanceof Error) {
        if (error.message.includes('API ã‚­ãƒ¼')) {
          errorMessage = 'Gemini API ã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚.env.localãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
        } else if (error.message.includes('500MB')) {
          errorMessage = error.message;
        } else if (error.message.includes('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯')) {
          errorMessage = 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
        } else {
          errorMessage = `ã‚¨ãƒ©ãƒ¼: ${error.message}`;
        }
      }

      setAnalysisResult(`âŒ ${errorMessage}\n\nè©³ç´°ã«ã¤ã„ã¦ã¯é–‹ç™ºè€…ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ã”ç¢ºèªãã ã•ã„ã€‚`);
    } finally {
      setIsAnalyzing(false);
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-green-50 to-blue-50 p-4">
      <div className="max-w-4xl mx-auto">
        {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
        <header className="text-center py-8">
          <h1 className="text-4xl font-bold text-gray-800 mb-2">
            ğŸŒï¸ Golf Analyze
          </h1>
          <p className="text-gray-600 text-lg">
            AIã§ã‚´ãƒ«ãƒ•ã‚¹ã‚¤ãƒ³ã‚°ã‚’è§£æã—ã¦ä¸Šé”ã‚’ã‚µãƒãƒ¼ãƒˆ
          </p>
          <p className="text-sm text-gray-500 mt-2">
            Powered by Google Gemini AI
          </p>
        </header>

        {/* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */}
        <main className="space-y-8">
          {/* ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */}
          <div className="bg-white rounded-lg shadow-lg p-6">
            <h2 className="text-2xl font-semibold text-gray-800 mb-4">
              ğŸ“¹ å‹•ç”»ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
            </h2>
            <div className="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-400 transition-colors">
              <input
                type="file"
                accept="video/*"
                onChange={handleFileChange}
                className="hidden"
                id="video-upload"
              />
              <label
                htmlFor="video-upload"
                className="cursor-pointer block"
              >
                <div className="mb-4">
                  <svg
                    className="mx-auto h-12 w-12 text-gray-400"
                    stroke="currentColor"
                    fill="none"
                    viewBox="0 0 48 48"
                  >
                    <path
                      d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02"
                      strokeWidth={2}
                      strokeLinecap="round"
                      strokeLinejoin="round"
                    />
                  </svg>
                </div>
                <p className="text-lg text-gray-600 mb-2">
                  ã‚¯ãƒªãƒƒã‚¯ã—ã¦å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
                </p>
                <p className="text-sm text-gray-500">
                  MP4, MOV, AVI ãªã©ã®å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆæœ€å¤§500MBï¼‰
                </p>
              </label>

              {selectedFile && (
                <div className="mt-4 p-3 bg-green-50 rounded-lg">
                  <p className="text-green-800 font-medium">
                    âœ… é¸æŠæ¸ˆã¿: {selectedFile.name}
                  </p>
                  <p className="text-green-600 text-sm">
                    ã‚µã‚¤ã‚º: {(selectedFile.size / 1024 / 1024).toFixed(2)} MB
                  </p>
                  {selectedFile.size > 500 * 1024 * 1024 && (
                    <p className="text-red-600 text-sm mt-1">
                      âš ï¸ ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒ500MBã‚’è¶…ãˆã¦ã„ã¾ã™
                    </p>
                  )}
                </div>
              )}
            </div>
          </div>

          {/* è§£æãƒœã‚¿ãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */}
          <div className="bg-white rounded-lg shadow-lg p-6">
            <h2 className="text-2xl font-semibold text-gray-800 mb-4">
              ğŸ¤– AIè§£æ
            </h2>
            <button
              id="analyze-button"
              onClick={handleAnalyze}
              disabled={!selectedFile || isAnalyzing || (selectedFile && selectedFile.size > 500 * 1024 * 1024)}
              className={`w-full py-4 px-6 rounded-lg font-semibold text-lg transition-all ${
                !selectedFile || isAnalyzing || (selectedFile && selectedFile.size > 500 * 1024 * 1024)
                  ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                  : 'bg-blue-600 text-white hover:bg-blue-700 active:bg-blue-800'
              }`}
            >
              {isAnalyzing ? (
                <div className="flex items-center justify-center">
                  <div className="animate-spin rounded-full h-6 w-6 border-b-2 border-white mr-3"></div>
                  Gemini AIã§è§£æä¸­...
                </div>
              ) : (
                'ğŸš€ ã‚¹ã‚¤ãƒ³ã‚°è§£æã‚’é–‹å§‹'
              )}
            </button>
            <p className="text-xs text-gray-500 mt-2 text-center">
              â€» ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã„å ´åˆã€è§£æã«æ•°åˆ†ã‹ã‹ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™
            </p>
          </div>

          {/* çµæœè¡¨ç¤ºã‚»ã‚¯ã‚·ãƒ§ãƒ³ */}
          <div className="bg-white rounded-lg shadow-lg p-6">
            <h2 className="text-2xl font-semibold text-gray-800 mb-4">
              ğŸ“Š è§£æçµæœ
            </h2>
            <div
              id="result"
              className={`min-h-[200px] p-4 rounded-lg border-2 ${
                analysisResult
                  ? analysisResult.startsWith('âŒ')
                    ? 'bg-red-50 border-red-200'
                    : 'bg-green-50 border-green-200'
                  : 'bg-gray-50 border-gray-200'
              }`}
            >
              {analysisResult ? (
                <pre className="whitespace-pre-wrap text-gray-800 text-sm leading-relaxed font-sans">
                  {analysisResult}
                </pre>
              ) : (
                <div className="flex items-center justify-center h-full text-gray-500">
                  <div className="text-center">
                    <svg
                      className="mx-auto h-12 w-12 mb-3"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        strokeWidth={2}
                        d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
                      />
                    </svg>
                    <p>Gemini AIã®è§£æçµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</p>
                    <p className="text-sm mt-1">
                      å‹•ç”»ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦è§£æã‚’é–‹å§‹ã—ã¦ãã ã•ã„
                    </p>
                  </div>
                </div>
              )}
            </div>
          </div>
        </main>

        {/* ãƒ•ãƒƒã‚¿ãƒ¼ */}
        <footer className="text-center py-8 text-gray-500">
          <p>&copy; 2024 Golf Analyze. AI-powered golf improvement.</p>
        </footer>
      </div>
    </div>
  );
}
